#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/stat.h>
#include <fcntl.h>

#define NOM_FIFO "namedPipe"

int main(void) {
  if (mkfifo(NOM_FIFO, S_IRUSR | S_IWUSR) == -1) {
    perror("mkfifo");
    exit(EXIT_FAILURE);
  }

  int fd;
  ssize_t n;
  char message[100];
  switch (fork()) {
  case -1:
    perror("fork");
    exit(EXIT_FAILURE);
  case 0:
    fd = open(NOM_FIFO, O_RDONLY);
    if (fd == -1) {
      perror("open");
      exit(EXIT_FAILURE);
    }
    while ((n = read(fd, message, sizeof(message))) > 0) {
      printf("Lecture d\'un message %s\n", message);
    }
    if (n == -1) {
      perror("read");
      exit(EXIT_FAILURE);
    }
    if (close(fd) == -1) {
        perror("close");
        exit(EXIT_FAILURE);
    }
    break;
  default:
    fd = open(NOM_FIFO, O_WRONLY);
    if (fd == -1) {
      perror("open");
      exit(EXIT_FAILURE);
    }
    if (unlink(NOM_FIFO) == -1) {
      perror("unlink");
      exit(EXIT_FAILURE);
    }
    char message[100];
      if (write(fd, "Je vous envoie le message?\n", sizeof("Je vous envoie le message?\n")) == -1) {
        perror("write");
        exit(EXIT_FAILURE);
	}
    if (close(fd) == -1) {
        perror("close");
        exit(EXIT_FAILURE);
    }
    break;
  }
  exit(EXIT_SUCCESS);
}

