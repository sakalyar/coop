// Pour ftruncate
#ifdef _XOPEN_SOURCE
#undef _XOPEN_SOURCE
#define _XOPEN_SOURCE 500
#endif

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <string.h>

struct data {
	int i;
	char c[10];
};


/**
 * Un nom de segment de mémoire partagé avec un identifiant pour nous assurer de son unicité.
 */
#define NOM_SHM "/mon_shm_a_moi_589422985365427"
#define TAILLE_SHM sizeof(int)

int main(void) {
  // On commence par créer un segment de mémoire partagée pour stocker notre variable
  
  int shm_fd = shm_open(NOM_SHM, O_RDWR | O_CREAT | O_EXCL, S_IRUSR | S_IWUSR);
  if (shm_fd == -1) {
    perror("shm_open");
    exit(EXIT_FAILURE);
  }

  // On supprime tout de suite le segment pour ne pas oublier.
  // Le segment ne sera réellement supprimé que quand plus
  // personne ne l'utilisera.
  if (shm_unlink(NOM_SHM) == -1) {
    perror("shm_unlink");
    exit(EXIT_FAILURE);
  }

  // On fixe la taille de notre shm.
  if (ftruncate(shm_fd, TAILLE_SHM) == -1) {
    perror("ftruncate");
    exit(EXIT_FAILURE);
  }

  // On projette notre sémaphore en mémoire.
  // On récupère ainsi l'adresse de notre variable partagée
  struct data *rdv;
  
  rdv = mmap(NULL, TAILLE_SHM, PROT_READ | PROT_WRITE, MAP_SHARED, shm_fd, 0);
  if (rdv == MAP_FAILED) {
    perror("mmap");
    exit(EXIT_FAILURE);
  }

  // On n'a plus besoin du descripteur du le shm
  if (close(shm_fd) == -1) {
    perror("close");
    exit(EXIT_FAILURE);
  }
  
  // Le rendez-vous est atteint lorsque la variable vaut 1
  rdv->i = 5;
  strcpy(rdv->c, "0123456789");

  // On se duplique
  switch (fork()) {
  case -1:
    perror("fork");
    exit(EXIT_FAILURE);
  case 0:
	while (rdv->i == 5);
    printf("Le int que nous avons passé: %d\n", rdv->i);
    exit(EXIT_SUCCESS);
  default:
    printf("La chaine des caractères que nous avons passé %s\n", rdv->c);
    rdv->i = 3;
    exit(EXIT_SUCCESS);
  }

  // À la fin du (des) processus,
  // la projection mémoire est automatiquement détruite.
}
















//~ #include <stdio.h> 
//~ #include <sys/shm.h> 
//~ #include <sys/stat.h> 

//~ int main () 
//~ {
  //~ int segment_id; 
  //~ char* shared_memory; 
  //~ struct shmid_ds shmbuffer; 
  //~ int segment_size; 
  //~ const int shared_segment_size = 0x6400; 

  //~ /* Allocate a shared memory segment.  */ 
  //~ segment_id = shmget (IPC_PRIVATE, shared_segment_size, 
                 //~ IPC_CREAT | IPC_EXCL | S_IRUSR | S_IWUSR); 
  //~ /* Attach the shared memory segment.  */ 
  //~ shared_memory = (char*) shmat (segment_id, 0, 0); 
  //~ printf ("shared memory attached at address %p\n", shared_memory); 
  //~ /* Determine the segment's size. */ 
  //~ shmctl (segment_id, IPC_STAT, &shmbuffer); 
  //~ segment_size  =               shmbuffer.shm_segsz; 
  //~ printf ("segment size: %d\n", segment_size); 
  //~ /* Write a string to the shared memory segment.  */ 
  //~ sprintf (shared_memory, "Hello, world."); 
  //~ /* Detach the shared memory segment.  */ 
  //~ shmdt (shared_memory); 

  //~ /* Reattach the shared memory segment, at a different address.  */ 
  //~ shared_memory = (char*) shmat (segment_id, (void*) 0x5000000, 0); 
  //~ printf ("shared memory reattached at address %p\n", shared_memory); 
  //~ /* Print out the string from shared memory.  */ 
  //~ printf ("%s\n", shared_memory); 
  //~ /* Detach the shared memory segment.  */ 
  //~ shmdt (shared_memory); 
	//~ shmctl (segment_id, IPC_RMID, 0);	 

  //~ return 0; 
//~ } 
